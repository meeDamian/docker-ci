name: build

#on:
#  push:
#    branches:
#    - master

on: push

jobs:
  faster:
    name: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v1

    - name: All
      run: docker build -t sample-image --file Dockerfile .

    - name: Save all build containers to files
      run: |
        mkdir -p out/
        docker images sample-image --format "{{.Repository}}:{{.Tag}}" | xargs -I% sh -c "docker save % | gzip > out/%.tgz"
        for file in $(ls out/); do
          mv out/${file} out/$(echo ${file} | tr : -)
        done

    - name: extract file from container
      run: |
        ls -la
        ID=$(docker create sample-image)
        docker cp "${ID}:/files/" out/
        docker rm -v "${ID}"

    - name: Update README & description on Docker Hub
      id: a-unique-step-id
      uses: meeDamian/sync-readme@step-output
      with:
        pass: ${{ secrets.DOCKER_PASS }}

    - name: Upload
      uses: actions/upload-artifact@v1.0.0
      with:
        name: containers
        path: out/

    - name: Steps info
      run: echo "${{ toJson(job) }}"

    - name: Steps info
      run: echo "${{ toJson(steps.a-unique-step-id) }}"

    - name: Dump GitHub context
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}
      run: echo "$GITHUB_CONTEXT"
    - name: Dump strategy context
      env:
        STRATEGY_CONTEXT: ${{ toJson(strategy) }}
      run: echo "$STRATEGY_CONTEXT"
    - name: Dump matrix context
      env:
        MATRIX_CONTEXT: ${{ toJson(matrix) }}
      run: echo "$MATRIX_CONTEXT"
    - name: Dump job context
      env:
        JOB_CONTEXT: ${{ toJson(job) }}
      run: echo "$JOB_CONTEXT"
    - name: Dump runner context
      env:
        RUNNER_CONTEXT: ${{ toJson(runner) }}
      run: echo "$RUNNER_CONTEXT"
    - name: Dump steps context
      env:
        STEPS_CONTEXT: ${{ toJson(steps) }}
      run: echo "$STEPS_CONTEXT"


    - name: Update README & description on Docker Hub
      if: startsWith(github.ref, 'refs/tags/')
      uses: meeDamian/sync-readme@v1.0.4
      with:
        pass: ${{ secrets.DOCKER_PASS }}
        description: true



